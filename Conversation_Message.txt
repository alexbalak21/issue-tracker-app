package app.service;

import app.model.Conversation;
import app.model.Ticket;
import app.repository.ConversationRepository;
import app.repository.TicketRepository;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;

@Service
public class ConversationService {

    private final ConversationRepository conversationRepository;
    private final TicketRepository ticketRepository;

    public ConversationService(ConversationRepository conversationRepository,
                               TicketRepository ticketRepository) {
        this.conversationRepository = conversationRepository;
        this.ticketRepository = ticketRepository;
    }

    public Conversation getConversationById(int id) {
        return conversationRepository.findById(id).orElse(null);
    }

    public Conversation getByTicketId(Long ticketId) {
        return conversationRepository.findByTicketId(ticketId);
    }

    public Conversation createConversationForTicket(Long ticketId) {
        Ticket ticket = ticketRepository.findById(ticketId)
                .orElseThrow(() -> new RuntimeException("Ticket not found"));

        Conversation conv = new Conversation();
        conv.setTicket(ticket);
        conv.setCreatedAt(LocalDateTime.now());
        conv.setUpdatedAt(LocalDateTime.now());

        return conversationRepository.save(conv);
    }
}


package app.service;

import app.model.Conversation;
import app.model.Message;
import app.repository.ConversationRepository;
import app.repository.MessageRepository;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.List;

@Service
public class MessageService {

    private final MessageRepository messageRepository;
    private final ConversationRepository conversationRepository;
    private final AuthService authService;

    public MessageService(MessageRepository messageRepository,
                          ConversationRepository conversationRepository,
                          AuthService authService) {
        this.messageRepository = messageRepository;
        this.conversationRepository = conversationRepository;
        this.authService = authService;
    }

    public Message addMessage(int conversationId, String body) {

        Long userId = authService.getCurrentUserId();

        Conversation conv = conversationRepository.findById(conversationId)
                .orElseThrow(() -> new RuntimeException("Conversation not found"));

        Message msg = new Message();
        msg.setConversation(conv);
        msg.setSenderId(userId.intValue());
        msg.setBody(body);
        msg.setCreatedAt(LocalDateTime.now());
        msg.setUpdatedAt(LocalDateTime.now());

        return messageRepository.save(msg);
    }

    public List<Message> getMessages(int conversationId) {
        return messageRepository.findByConversationIdOrderByCreatedAtAsc(conversationId);
    }
}



package app.controller;

import app.model.Message;
import app.security.Ownership;
import app.security.OwnershipType;
import app.security.RequiresPermission;
import app.service.MessageService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/conversations")
public class MessageController {

    private final MessageService messageService;

    public MessageController(MessageService messageService) {
        this.messageService = messageService;
    }

    // ----------------------------------------------------
    // GET messages for a conversation
    // USER can only view their own conversation
    // ----------------------------------------------------
    @GetMapping("/{conversationId}/messages")
    @RequiresPermission("conversation.read")
    @Ownership(OwnershipType.ALL_OR_SELF)
    public List<Message> getMessages(@PathVariable int conversationId) {
        return messageService.getMessages(conversationId);
    }

    // ----------------------------------------------------
    // POST message (reply)
    // USER can only reply to their own conversation
    // ----------------------------------------------------
    @PostMapping("/{conversationId}/messages")
    @RequiresPermission("conversation.reply")
    @Ownership(OwnershipType.ALL_OR_SELF)
    public ResponseEntity<Message> addMessage(
            @PathVariable int conversationId,
            @RequestBody String body
    ) {
        return ResponseEntity.ok(
                messageService.addMessage(conversationId, body)
        );
    }
}
